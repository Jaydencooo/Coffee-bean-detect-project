<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Coze 聊天窗口集成测试</title>
</head>
<body>
<h1>欢迎使用 Coze 聊天窗口</h1>

<!-- ========= Coze 聊天窗口集成脚本 ========= -->
<script>
    /* ===============================
       工具函数：safeLog
       - 用于防止中文在控制台输出时乱码
       - 会尝试把字符串做解码处理
       =============================== */
    function safeLog(...args) {
        const newArgs = args.map(arg => {
            if (typeof arg === 'string') {
                try {
                    return decodeURIComponent(escape(arg));
                } catch (e) {
                    return arg;
                }
            }
            return arg;
        });
        console.log(...newArgs);
    }

    /* ===============================
       第一步：从后端获取 Coze 配置
       - 向 Spring Boot 提供的 /api/coze/config 接口发送请求
       - 后端返回 JSON 数据: { botId, token }
       - 这里需要后端写一个接口返回 Coze 配置信息
       =============================== */
    async function fetchCozeConfig() {
        try {
            const response = await fetch('/api/coze/config'); // 调用后端接口
            if (!response.ok) {
                throw new Error("无法获取 Coze 配置");
            }
            return await response.json(); // 成功则返回 JSON 对象
        } catch (error) {
            safeLog("获取配置失败:", error);
            return null; // 出错返回 null
        }
    }

    /* ===============================
       第二步：动态加载 Coze SDK
       - 创建 <script> 标签，加载 Coze 官方 JS SDK
       - 成功后在 window 下挂载 CozeWebSDK
       =============================== */
    function loadCozeSDK() {
        return new Promise((resolve, reject) => {
            // 如果 SDK 已经加载过，就直接返回
            if (window.CozeWebSDK) return resolve(window.CozeWebSDK);

            const script = document.createElement('script');
            script.src = 'https://lf-cdn.coze.cn/obj/unpkg/flow-platform/chat-app-sdk/1.2.0-beta.10/libs/cn/index.js'; // SDK 地址
            script.async = true;
            script.onload = () => {
                if (window.CozeWebSDK) {
                    resolve(window.CozeWebSDK); // 成功加载
                } else {
                    reject(new Error("CozeWebSDK 加载失败"));
                }
            };
            script.onerror = () => reject(new Error("Coze SDK 脚本加载错误"));
            document.head.appendChild(script);
        });
    }

    /* ===============================
       第三步：初始化聊天组件
       - 先从后端拿配置（botId 和 token）
       - 加载 SDK
       - 使用 Coze 提供的 WebChatClient 初始化聊天窗口
       =============================== */
    async function bootstrapCozeChat() {
        // 从后端获取 botId 和 token
        const configData = await fetchCozeConfig();
        safeLog("获取到的配置:", configData);

        if (!configData || !configData.botId || !configData.token) {
            safeLog("无法初始化 Coze 聊天窗口，因为配置获取失败或不完整");
            return;
        }

        const { botId, token } = configData;

        // 加载 SDK
        let Coze;
        try {
            Coze = await loadCozeSDK();
        } catch (err) {
            safeLog("Coze SDK 加载失败:", err);
            return;
        }

        // 确保 SDK 正常加载
        if (!Coze || !Coze.WebChatClient) {
            safeLog("Coze.WebChatClient 未定义，初始化失败");
            return;
        }

        // 初始化 Coze 聊天窗口
        const client = new Coze.WebChatClient({
            config: { bot_id: botId },  // 必须传 bot_id
            componentProps: {
                title: '咖啡豆小助手',           // 聊天窗口标题
                placeholder: '输入问题，按回车发送', // 输入框提示
                theme: 'light',                  // 可选 light | dark | auto
            },
            auth: {
                type: 'token', // 使用 token 授权
                token: token,
                // 支持自动刷新 token
                onRefreshToken: async () => {
                    const newConfig = await fetchCozeConfig();
                    return newConfig ? newConfig.token : token;
                },
            },
        });

        // 可选：默认收起聊天窗口
        // client.minimize();

        // 挂载到全局，方便在控制台调试
        window.__cozeClient = client;
        safeLog("Coze 聊天窗口初始化完成");
    }

    /* ===============================
       第四步：等待 DOM 加载完成后执行
       - 如果文档还在 loading 状态，监听 DOMContentLoaded
       - 否则立即执行
       =============================== */
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', bootstrapCozeChat);
    } else {
        bootstrapCozeChat();
    }
</script>
</body>
</html>
